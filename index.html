<!DOCTYPE html>
<html>
	<title>MyVIBO</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

	<!--<link rel="stylesheet" href="css/jquery.mobile-1.3.2.min.css" />--><!--JQuery Mobile theme-->
	<link rel="stylesheet" href="css/jquery.mobile.structure-1.3.2.min.css" />
	<link rel="stylesheet" href="css/vmall.min.css" /><!--將JQuery Mobile theme加上 swatch="F"-->
	<link rel="stylesheet" href="css/jquery.mobile.simpledialog.min.css" /><!--類似alert的dialog，請參考 http://dev.jtsage.com/jQM-SimpleDialog/demos2/ -->
	<link rel="stylesheet" href="css/style.css" />
	
	<script src="js/jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="js/initJQueryMobile.js"></script><!--初始化 JQuery Mobile -->
	<script src="js/jquery.mobile-1.3.2.min.js"></script>
	<script src="js/jquery.mobile.simpledialog2.min.js"></script><!--類似alert的dialog，請參考 http://dev.jtsage.com/jQM-SimpleDialog/demos2/ -->
	<script type="text/javascript" src="js/util.js"></script>
	<!--<script type="text/javascript" src="js/ga.js"></script>--><!--Browser用的Google Analytics 追蹤函數-->
	<script type="text/javascript" src="js/jquery.blockUI.js"></script><!--JQuery BlockUI，請參考http://www.malsup.com/jquery/block/ -->
	<script src="cordova.js"></script><!--給PhoneGap用的-->
	<script type="text/javascript" src="js/phonegap-nfc.js"></script><!--NFC，請參考https://github.com/chariotsolutions/phonegap-nfc -->
	<script src="js/plugins/LaunchMyApp.js"></script><!--Launch my app，請參考 https://github.com/EddyVerbruggen/LaunchMyApp-PhoneGap-Plugin/blob/d1432ecfff63678a3155804839dda21607706e72/README.md -->
	<!--<script src="js/barcodescanner.js"></script>--><!--Barcode scanner，請參考 https://github.com/phonegap-build/BarcodeScanner/blob/9270025f71891b2f46a38b7bc3d1223b4955dce2/README.md -->
	
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>

<body>

<!-- ****************************** 首頁 ***********************************-->
<div data-role="page" id="home">
	<div data-role="header" data-position="fixed" class="vibo-header">
		<div class="header-padding"></div>
		<div data-role="navbar">
			<ul class="navbar-content-area">
				<li><a href="#home">V-Living NFC測試</a></li>
				<li><a href="#coupon">我的折價券</a></li>
				<li><a href="#shop">商家POS</a></li>
			</ul>
		</div><!-- /navbar -->
	</div><!-- /header -->
	
	<div data-role="content">
		<!--
		<input type="button" value="設定監聽器" onclick="setListener();">
		<hr>
		-->
		<div>威寶企網首頁</div>
		<input type="text" name="text1" id="text1" value="http://www.vibo.com.tw/">
		<input type="button" value="寫入NFC Tag" onclick="writeTag('text1');">
		<hr>
		<div>面對面的讚，更讚! 拔牙篇_完整版</div>
		<input type="text" name="text2" id="text2" value="https://www.youtube.com/watch?v=S-diRjy6DKU">
		<input type="button" value="寫入NFC Tag" onclick="writeTag('text2');">
		<hr>
		<div>【鋼鐵人３】中文戲院版預告 [Full HD]</div>
		<input type="text" name="text3" id="text3" value="https://www.youtube.com/watch?v=XNrSGoq_77k">
		<input type="button" value="寫入NFC Tag" onclick="writeTag('text3');">
		<hr>
		<div>威寶週年慶抽獎活動</div>
		<input type="text" name="text4" id="text4" value="http://event.vibo.net.tw/201312/index.html">
		<input type="button" value="寫入NFC Tag" onclick="writeTag('text4');">
		<hr>
		<div>折價券</div>
		<input type="text" name="text5" id="text5" value="nfctest://index.html?c=麥當勞">
		<input type="button" value="寫入NFC Tag" onclick="writeTag('text5');">
	</div><!-- /content -->
</div><!-- 首頁 -->

<!-- ****************************** 折價券 ***********************************-->
<div data-role="page" id="coupon">
	<div data-role="header" data-position="fixed" class="vibo-header">
		<div class="header-padding"></div>
		<div data-role="navbar">
			<ul class="navbar-content-area">
				<li><a href="#home">V-Living NFC測試</a></li>
				<li><a href="#coupon">我的折價券</a></li>
				<li><a href="#shop">商家POS</a></li>
			</ul>
		</div><!-- /navbar -->
	</div><!-- /header -->
	
	<div data-role="content">
		<div>我的折價券</div>
		<img src="images/qrcode.jpg" />
	</div><!-- /content -->
</div><!-- 折價券 -->

<!-- ****************************** 商家POS ***********************************-->
<div data-role="page" id="shop">
	<div data-role="header" data-position="fixed" class="vibo-header">
		<div class="header-padding"></div>
		<div data-role="navbar">
			<ul class="navbar-content-area">
				<li><a href="#home">V-Living NFC測試</a></li>
				<li><a href="#coupon">我的折價券</a></li>
				<li><a href="#shop">商家POS</a></li>
			</ul>
		</div><!-- /navbar -->
	</div><!-- /header -->
	
	<div data-role="content">
		<div>商家POS系統</div>
		<input type="button" value="掃描折價券" onclick="doScan();">
	</div><!-- /content -->
</div><!-- 商家POS -->

</body>
</html>
<script type="text/javascript" src="js/initPage.js"></script><!--初始化頁面，設定header及footer -->

<script type="text/javascript">

	var sRecord = "";	//寫入至NFC的內容，若此變數無值則不寫入NFC
	var sCoupon = "";	//目前是否有折價券，若此變數有值則跳至coupon頁

	document.addEventListener("deviceready", onDeviceReady, false);
	
	function onDeviceReady() {	//程式啟動時先設定監聽器
		//nfc.addTagDiscoveredListener(function(){writeToTag();}, function(){alert("設定監聽器成功");}, function(){alert("設定監聽器失敗");});
		nfc.addTagDiscoveredListener(function(){writeToTag();}, function(){}, function(){alert("設定監聽器失敗");});
		if (notEmpty(sCoupon)){	//從外部掃描NFC取得coupon
			sCoupon = "";
			showPage("#coupon");
			alert("恭喜您獲得" + sCoupon + "折價券一張");
			/*
			cordova.exec(
				function(success) {
					alert("encode success: " + success);
				},
				function(fail) {
					alert("encoding failed: " + fail);
				},
				'BarcodeScanner',
				'encode',
				[
					{"type": "TEXT_TYPE", "data": 'http://www.google.com/', "options": ''}
				]
			);	//cordova.exec(
			*/
		}	//if (notEmpty(sCoupon)){	//從外部掃描NFC取得coupon

	}	//function onDeviceReady() {	//程式啟動時先設定監聽器

	function handleOpenURL(url) {
		var s = getParameterByName("c", url);
		//alert("received url: " + url);
		if (notEmpty(s)){
			sCoupon = s;
		}
	}
	
	function writeTag(text){	//準備寫入NFC
		var s = $('#home #' + text).val();
		sRecord = s;
		showBlockUI();
	}	//function writeTag(text){	//準備寫入NFC

	function writeToTag(){	//當手機靠近NFC標籤時，將資料寫入NFC
		if (beEmpty(sRecord)) return;
		var message = [
			ndef.uriRecord(sRecord)
		];
		nfc.write(message, function(){unBlockUI();alert("寫入成功");sRecord="";}, function(){unBlockUI();alert("寫入失敗");});
	}	//function writeToTag(){	//當手機靠近NFC標籤時，將資料寫入NFC

	function setListener() {	//這個函數目前沒在用
		alert(typeof(nfc));
		nfc.addTagDiscoveredListener(function(){alert("addTagDiscoveredListener_detected");}, function(){alert("addTagDiscoveredListener_success");}, function(){alert("addTagDiscoveredListener_fail");});
		//ready();
		nfc.addMimeTypeListener('text/pg', function(){alert("addMimeTypeListener_detected");}, function(){alert("addMimeTypeListener_success");}, function(){alert("addMimeTypeListener_fail");});
		nfc.addNdefListener(function(){alert("addNdefListener_detected");}, function(){alert("addNdefListener_success");}, function(){alert("addNdefListener_fail");});
		nfc.addNdefFormatableListener(function(){alert("addNdefFormatableListener_detected");}, function(){alert("addNdefFormatableListener_success");}, function(){alert("addNdefFormatableListener_fail");});
		alert('done');
	}

	function doScan(){
			cordova.exec(
				function(success) {
					alert("encode success: " + success);
				},
				function(fail) {
					alert("encoding failed: " + fail);
				},
				'BarcodeScanner',
				'encode',
				[
					{"type": "TEXT_TYPE", "data": 'http://www.google.com/', "options": ''}
				]
			);	//cordova.exec(
		return;
		cordova.exec(function (result) {
				//alert("We got a barcode\n" + "Result: " + result.text + "\n" + "Format: " + result.format + "\n" + "Cancelled: " + result.cancelled);
				alert("成功取得折價券條碼!!");
			},
			function (error) {
				alert("條碼掃描失敗: " + error);
			},
			'BarcodeScanner', 'scan', []);
		//alert("0");
		//alert(typeof(ScannerLoader));
		//alert(typeof(cordova.plugins.BarcodeScanner));
		//alert(typeof(window.plugins.barcodeScanner));
		//alert(typeof(window.plugins.BarcodeScanner));
		/*
		ScannerLoader.scan(
			function (result) {
				alert("We got a barcode\n" + "Result: " + result.text + "\n" + "Format: " + result.format + "\n" + "Cancelled: " + result.cancelled);
			}, 
			function (error) {
				alert("Scanning failed: " + error);
			}
		);
		*/
	}
</script>
